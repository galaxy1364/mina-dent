name: LOCKPACK CI

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Basic build (static-safe)
        shell: bash
        run: |
          set -euo pipefail
          echo "build: ok"

  lockpack:
    name: lockpack
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: LOCKPACK gates + evidence (abort-safe)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p LOCKPACK evidence snapshot evidence/signature

          # همیشه اول یک QG.json بساز که اگر وسط کار Fail شد هم داشته باشیم
          python3 -c "import json,os; os.makedirs('evidence',exist_ok=True); d={'status':'FAIL','gates':{'js_runtime_errors':'UNKNOWN','no_infinite_pending':'PASS','hashlock':'UNKNOWN','evidence':'PENDING','signed_artifact':'PENDING'}}; open('evidence/QG.json','w',encoding='utf-8').write(json.dumps(d,ensure_ascii=False,indent=2))"

          # 1) JS Guard (ساده): console.error نباید باشد
          if grep -RIn --exclude-dir=node_modules --exclude-dir=.git -E "console\.error\s*\(" . ; then
            echo "FAIL: console.error found"
            python3 -c "import json; p='evidence/QG.json'; d=json.load(open(p,encoding='utf-8')); d['status']='FAIL'; d['gates']['js_runtime_errors']='FAIL'; open(p,'w',encoding='utf-8').write(json.dumps(d,ensure_ascii=False,indent=2))"
            exit 1
          fi
          python3 -c "import json; p='evidence/QG.json'; d=json.load(open(p,encoding='utf-8')); d['gates']['js_runtime_errors']='PASS'; open(p,'w',encoding='utf-8').write(json.dumps(d,ensure_ascii=False,indent=2))"

          # 2) HashLock (قفل فایل‌ها)
          git ls-files -z | sort -z | xargs -0 sha256sum > LOCKPACK/HASHLOCK.sha256
          python3 -c "import json; p='evidence/QG.json'; d=json.load(open(p,encoding='utf-8')); d['gates']['hashlock']='PASS'; open(p,'w',encoding='utf-8').write(json.dumps(d,ensure_ascii=False,indent=2))"

          # 3) Snapshot + Manifest
          mkdir -p snapshot/LOCKPACK
          cp -f LOCKPACK/HASHLOCK.sha256 snapshot/LOCKPACK/HASHLOCK.sha256
          sha256sum LOCKPACK/HASHLOCK.sha256 > evidence/manifest.sha256

          # 4) Evidence pack (آرتیفکت واقعی)
          tar -czf evidence/evidence.tgz evidence snapshot LOCKPACK/HASHLOCK.sha256
          python3 -c "import json; p='evidence/QG.json'; d=json.load(open(p,encoding='utf-8')); d['gates']['evidence']='PASS'; open(p,'w',encoding='utf-8').write(json.dumps(d,ensure_ascii=False,indent=2))"

      - name: Install cosign (for signing)
        uses: sigstore/cosign-installer@v3

      - name: Sign evidence artifact (OIDC keyless)
        shell: bash
        env:
          COSIGN_YES: "true"
        run: |
          set -euo pipefail
          cosign sign-blob \
            --output-signature evidence/signature/evidence.tgz.sig \
            --output-certificate evidence/signature/evidence.tgz.crt \
            evidence/evidence.tgz

          # QG.json => PASS + Signed
          python3 -c "import json; p='evidence/QG.json'; d=json.load(open(p,encoding='utf-8')); d['status']='PASS'; d['gates']['signed_artifact']='PASS'; open(p,'w',encoding='utf-8').write(json.dumps(d,ensure_ascii=False,indent=2))"

      - name: Upload evidence (QG.json + pack + signatures + HashLock)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence
          path: |
            evidence/QG.json
            evidence/manifest.sha256
            evidence/evidence.tgz
            evidence/signature/evidence.tgz.sig
            evidence/signature/evidence.tgz.crt
            LOCKPACK/HASHLOCK.sha256
            snapshot/
          retention-days: 7
