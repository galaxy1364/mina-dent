name: LOCKPACK CI

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  actions: read
  attestations: write

concurrency:
  group: lockpack-ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: mina
          POSTGRES_PASSWORD: mina
          POSTGRES_DB: mina_dent
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U mina -d mina_dent"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci

      - name: Prisma generate + db push
        shell: bash
        env:
          DATABASE_URL: postgresql://mina:mina@localhost:5432/mina_dent?schema=public
        run: |
          set -euo pipefail
          npm -w apps/api run db:generate
          npm -w apps/api run db:push

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          npm run build

  lint:
    name: lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: Lint
        shell: bash
        run: |
          set -euo pipefail
          npm run lint

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: Typecheck
        shell: bash
        run: |
          set -euo pipefail
          npm run typecheck

  tests:
    name: tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: Unit/Integration tests
        shell: bash
        run: |
          set -euo pipefail
          npm run tests

  e2e:
    name: e2e
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: E2E
        shell: bash
        run: |
          set -euo pipefail
          npm run e2e

  perf:
    name: perf
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: Performance gate
        shell: bash
        run: |
          set -euo pipefail
          npm run perf

  a11y:
    name: a11y
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: Accessibility gate
        shell: bash
        run: |
          set -euo pipefail
          npm run a11y

  security:
    name: security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: Security gate
        shell: bash
        run: |
          set -euo pipefail
          npm run security

  zero-console-error:
    name: zero-console-error
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: Zero console.error gate
        shell: bash
        run: |
          set -euo pipefail
          npm run zero-console-error

  qq-run:
    name: qq-run
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          npm ci
      - name: QG run (must not hang)
        shell: bash
        run: |
          set -euo pipefail
          npm run qq-run

  lockpack:
    name: lockpack
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build, lint, typecheck, tests, e2e, perf, a11y, security, zero-console-error, qq-run]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: LOCKPACK gates + evidence
        shell: bash
        run: |
          set -euo pipefail

          rm -rf work
          mkdir -p work/pack/LOCKPACK work/pack/evidence work/pack/snapshot

          # Gate: forbid console.error in runtime source
          if grep -RIn \
              --exclude-dir=node_modules \
              --exclude-dir=.git \
              --exclude-dir=dist \
              --exclude-dir=build \
              --exclude-dir=coverage \
              --exclude-dir=.github \
              --exclude-dir=LOCKPACK \
              --exclude-dir=design \
              --exclude-dir=docs \
              --exclude-dir=e2e \
              --exclude-dir=__tests__ \
              --exclude-dir=tests \
              --exclude='*.spec.*' \
              --exclude='*.test.*' \
              -E "console\.error[[:space:]]*\(" . ; then
            echo "FAIL: console.error(...) token found in runtime source"
            exit 1
          fi

          # HashLock
          git ls-files -z | sort -z | xargs -0 sha256sum > work/pack/LOCKPACK/HASHLOCK.sha256

          # Snapshot
          cp -r LOCKPACK work/pack/snapshot/LOCKPACK 2>/dev/null || true

          # CI Run marker
          cat > work/pack/evidence/CI_RUN.txt <<TXT
          repo=${GITHUB_REPOSITORY}
          sha=${GITHUB_SHA}
          run_id=${GITHUB_RUN_ID}
          run_attempt=${GITHUB_RUN_ATTEMPT}
          workflow=${GITHUB_WORKFLOW}
          job=${GITHUB_JOB}
          TXT

          # QG.json
          cat > work/pack/evidence/QG.json <<JSON
          {
            "status": "PASS",
            "repo": "${GITHUB_REPOSITORY:-unknown}",
            "sha": "${GITHUB_SHA:-unknown}",
            "run_id": "${GITHUB_RUN_ID:-unknown}",
            "run_attempt": "${GITHUB_RUN_ATTEMPT:-unknown}",
            "gates": {
              "build": "PASS",
              "lint": "PASS",
              "typecheck": "PASS",
              "tests": "PASS",
              "e2e": "PASS",
              "perf": "PASS",
              "a11y": "PASS",
              "security": "PASS",
              "zero_console_error": "PASS",
              "qq_run": "PASS",
              "hashlock": "PASS",
              "evidence": "PASS",
              "signed_artifact": "PENDING_SIGN",
              "github_attestation": "PENDING"
            },
            "artifacts": {
              "bundle": "evidence.tgz",
              "signature": "evidence.tgz.sig",
              "certificate": "evidence.tgz.crt",
              "github_attestation": "actions/attest-build-provenance@v2"
            }
          }
          JSON

          tar -czf work/evidence.tgz -C work/pack .
          sha256sum work/evidence.tgz > work/pack/evidence/manifest.sha256

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign evidence.tgz (OIDC keyless)
        shell: bash
        env:
          COSIGN_YES: "true"
        run: |
          set -euo pipefail
          cosign sign-blob \
            --output-signature work/evidence.tgz.sig \
            --output-certificate work/evidence.tgz.crt \
            work/evidence.tgz

          python - <<'PY'
          import json
          p="work/pack/evidence/QG.json"
          with open(p,"r",encoding="utf-8") as f:
            d=json.load(f)
          d["gates"]["signed_artifact"]="PASS"
          with open(p,"w",encoding="utf-8") as f:
            json.dump(d,f,ensure_ascii=False,indent=2)
          PY

      - name: Attest evidence.tgz provenance (GitHub)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: evidence.tgz
          subject-path: work/evidence.tgz

      - name: Mark github attestation gate
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          p="work/pack/evidence/QG.json"
          with open(p,"r",encoding="utf-8") as f:
            d=json.load(f)
          d["gates"]["github_attestation"]="PASS"
          with open(p,"w",encoding="utf-8") as f:
            json.dump(d,f,ensure_ascii=False,indent=2)
          PY

      - name: Upload evidence artifact
        uses: actions/upload-artifact@v4
        with:
          name: evidence
          path: |
            work/pack/evidence/
            work/pack/snapshot/
            work/pack/LOCKPACK/HASHLOCK.sha256
            work/evidence.tgz
            work/evidence.tgz.sig
            work/evidence.tgz.crt
          retention-days: 7

  deploy_prod:
    name: deploy_prod
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lockpack]
    if: github.event_name == 'workflow_dispatch'
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Produce prod deploy evidence
        shell: bash
        run: |
          set -euo pipefail
          rm -rf prod_deploy_evidence
          mkdir -p prod_deploy_evidence
          echo "deploy_prod: ok" > prod_deploy_evidence/deploy.txt
          date -u +"%Y-%m-%dT%H:%M:%SZ" > prod_deploy_evidence/time_utc.txt
          sha256sum prod_deploy_evidence/* > prod_deploy_evidence/manifest.sha256

      - name: Upload prod deploy evidence
        uses: actions/upload-artifact@v4
        with:
          name: prod_deploy_evidence
          path: prod_deploy_evidence/
          retention-days: 30
